################################################################################
# NEKO DEEP ERROR DETECTION WORKFLOW
# ============================================================================
# This workflow performs comprehensive error detection and testing for the
# Neko Bug Bounty Automation Framework. It tests:
# - Installation process and dependencies
# - Syntax validation for all scripts
# - Library and module loading
# - Function availability and integration
# - Configuration validation
#
# ARCHITECTURE NOTES:
# - Complex bash logic is moved to .github/scripts/ for proper shell options
# - Uses `printf '%s\n'` instead of unsafe `printf $var` patterns
# - Uses `set -euo pipefail` in helper scripts for proper error handling
# - Jobs use `continue-on-error` and `if: always()` for proper dependency chains
#
# NOTE: This workflow DOES NOT perform actual scanning - it focuses on
# finding errors in the codebase, installation, and configuration.
################################################################################

name: Neko Deep Error Detection

on:
  push:
    branches: [ main, master, develop, 'feature/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable extra debug logging'
        required: false
        default: 'true'
        type: boolean
      skip_installation:
        description: 'Skip full tool installation (faster but less comprehensive)'
        required: false
        default: 'false'
        type: boolean
      skip_api_tests:
        description: 'Skip API key validation tests'
        required: false
        default: 'false'
        type: boolean

env:
  VERBOSE_LOGGING: 'true'
  DEBUG_MODE: 'true'
  LOG_TIMESTAMP_FORMAT: '%Y-%m-%d %H:%M:%S'
  CHAOS_API_KEY: ${{ secrets.CHAOS_API_KEY }}
  SECURITYTRAILS_API_KEY: ${{ secrets.SECURITYTRAILS_API_KEY }}
  SHODAN_API_KEY: ${{ secrets.SHODAN_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.TOKEN }}
  VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
  TOOLS_PATH: /home/runner/Tools
  WORDLISTS_PATH: /home/runner/Tools/wordlists

################################################################################
# JOBS
################################################################################

jobs:
  ################################################################################
  # JOB 1: Environment Information and Setup
  ################################################################################
  environment-info:
    name: "1. Environment Information"
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.timestamp }}
      run_id: ${{ steps.timestamp.outputs.run_id }}
    steps:
      - name: Generate timestamps and IDs
        id: timestamp
        run: |
          set -euo pipefail
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          RUN_ID="${TIMESTAMP}_${{ github.run_number }}"
          printf 'timestamp=%s\n' "$TIMESTAMP" >> "$GITHUB_OUTPUT"
          printf 'run_id=%s\n' "$RUN_ID" >> "$GITHUB_OUTPUT"
          
          printf '%s\n' "========================================"
          printf '%s\n' "NEKO DEEP ERROR DETECTION"
          printf '%s\n' "========================================"
          printf '%s\n' "Run ID: ${RUN_ID}"
          printf '%s\n' "Timestamp: ${TIMESTAMP}"
          printf '%s\n' "GitHub Event: ${{ github.event_name }}"
          printf '%s\n' "GitHub Ref: ${{ github.ref }}"
          printf '%s\n' "========================================"

      - name: System Information
        run: |
          set -euo pipefail
          printf '%s\n' "========================================"
          printf '%s\n' "SYSTEM INFORMATION"
          printf '%s\n' "========================================"
          printf '\n%s\n' "--- Operating System ---"
          cat /etc/os-release
          printf '\n%s\n' "--- Kernel ---"
          uname -a
          printf '\n%s\n' "--- CPU Information ---"
          nproc
          lscpu | head -20
          printf '\n%s\n' "--- Memory ---"
          free -h
          printf '\n%s\n' "--- Disk Space ---"
          df -h /
          printf '\n%s\n' "--- Environment Variables (non-sensitive) ---"
          env | grep -v "KEY\|TOKEN\|SECRET\|PASS" | sort || true
          printf '%s\n' "========================================"

      - name: Check Available Tools
        run: |
          set -euo pipefail
          printf '%s\n' "========================================"
          printf '%s\n' "PRE-INSTALLED TOOLS CHECK"
          printf '%s\n' "========================================"
          
          check_tool() {
            local tool="$1"
            if command -v "$tool" &>/dev/null; then
              local version
              version=$("$tool" --version 2>/dev/null | head -1 || printf '%s' 'version unknown')
              printf '[OK] %s: %s - %s\n' "$tool" "$(command -v "$tool")" "$version"
            else
              printf '[MISSING] %s\n' "$tool"
            fi
          }
          
          printf '\n%s\n' "--- Essential Tools ---"
          check_tool bash
          check_tool curl
          check_tool wget
          check_tool git
          check_tool jq
          check_tool python3
          check_tool pip3
          check_tool go
          check_tool make
          
          printf '\n%s\n' "--- Network Tools ---"
          check_tool nmap
          check_tool nc
          check_tool whois
          check_tool dig
          
          printf '%s\n' "========================================"

  ################################################################################
  # JOB 2: Syntax Validation (Uses Helper Script)
  ################################################################################
  syntax-validation:
    name: "2. Syntax Validation"
    runs-on: ubuntu-latest
    needs: environment-info
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/syntax
          printf 'Run ID: %s\n' "${{ needs.environment-info.outputs.run_id }}" > logs/syntax/run_info.txt
          printf 'Started: %s\n' "$(date)" >> logs/syntax/run_info.txt

      - name: Validate Bash Script Syntax
        id: bash_syntax
        run: |
          set -euo pipefail
          chmod +x .github/scripts/validate-syntax.sh
          ./.github/scripts/validate-syntax.sh

      - name: Install ShellCheck
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y -qq shellcheck

      - name: Run ShellCheck Analysis
        id: shellcheck
        continue-on-error: true
        run: |
          set -euo pipefail
          
          SHELLCHECK_LOG="logs/syntax/shellcheck_results.log"
          
          printf '%s\n' "========================================"  > "$SHELLCHECK_LOG"
          printf '%s\n' "SHELLCHECK ANALYSIS"                     >> "$SHELLCHECK_LOG"
          printf '%s\n' "========================================"  >> "$SHELLCHECK_LOG"
          printf 'Timestamp: %s\n' "$(date)"                       >> "$SHELLCHECK_LOG"
          printf '\n'                                               >> "$SHELLCHECK_LOG"
          
          ISSUES_FOUND=0
          
          while IFS= read -r script; do
            printf '\n--- %s ---\n' "$script" >> "$SHELLCHECK_LOG"
            
            if shellcheck -f gcc "$script" >> "$SHELLCHECK_LOG" 2>&1; then
              printf '  [OK] No issues\n' >> "$SHELLCHECK_LOG"
            else
              ISSUES_FOUND=$((ISSUES_FOUND + 1))
            fi
          done < <(find . -name "*.sh" -type f ! -path "./.git/*" 2>/dev/null)
          
          # Count issues by severity - handle grep exit codes properly
          ERROR_COUNT=$(grep -c ":error:" "$SHELLCHECK_LOG" 2>/dev/null) || ERROR_COUNT=0
          WARN_COUNT=$(grep -c ":warning:" "$SHELLCHECK_LOG" 2>/dev/null) || WARN_COUNT=0
          NOTE_COUNT=$(grep -c ":note:" "$SHELLCHECK_LOG" 2>/dev/null) || NOTE_COUNT=0
          
          printf '\n%s\n' "========================================"
          printf '%s\n' "SHELLCHECK SUMMARY"
          printf '%s\n' "========================================"
          printf 'Files with issues: %d\n' "$ISSUES_FOUND"
          printf 'Errors: %d\n' "$ERROR_COUNT"
          printf 'Warnings: %d\n' "$WARN_COUNT"
          printf 'Notes: %d\n' "$NOTE_COUNT"
          printf '%s\n' "========================================"
          
          # Show top issues
          printf '\n%s\n' "=== Top Issues (first 50 lines) ==="
          head -50 "$SHELLCHECK_LOG" || true

      - name: Upload Syntax Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: syntax-validation-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/syntax/
          retention-days: 30

  ################################################################################
  # JOB 3: Configuration Validation
  ################################################################################
  config-validation:
    name: "3. Configuration Validation"
    runs-on: ubuntu-latest
    needs: environment-info
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/config

      - name: Validate neko.cfg
        id: config_validation
        run: |
          set -euo pipefail
          
          CONFIG_LOG="logs/config/config_validation.log"
          CONFIG_FILE="neko.cfg"
          
          printf '%s\n' "========================================"  > "$CONFIG_LOG"
          printf '%s\n' "CONFIGURATION FILE VALIDATION"          >> "$CONFIG_LOG"
          printf '%s\n' "========================================"  >> "$CONFIG_LOG"
          printf 'Timestamp: %s\n' "$(date)"                       >> "$CONFIG_LOG"
          printf '\n'                                               >> "$CONFIG_LOG"
          
          if [[ ! -f "$CONFIG_FILE" ]]; then
            printf '[CRITICAL] neko.cfg not found!\n' | tee -a "$CONFIG_LOG"
            exit 1
          fi
          
          printf '%s\n' "=== Configuration File Details ===" >> "$CONFIG_LOG"
          printf 'File: %s\n' "$CONFIG_FILE" >> "$CONFIG_LOG"
          printf 'Size: %s bytes\n' "$(wc -c < "$CONFIG_FILE")" >> "$CONFIG_LOG"
          printf 'Lines: %s\n' "$(wc -l < "$CONFIG_FILE")" >> "$CONFIG_LOG"
          
          # Get variable count safely
          VAR_COUNT=$(grep -c '^\s*[A-Z_]*=' "$CONFIG_FILE" 2>/dev/null) || VAR_COUNT=0
          printf 'Variables: %d\n' "$VAR_COUNT" >> "$CONFIG_LOG"
          
          printf '\n%s\n' "=== Syntax Check ===" >> "$CONFIG_LOG"
          
          if bash -n "$CONFIG_FILE" 2>&1 | tee -a "$CONFIG_LOG"; then
            printf '[PASS] Configuration syntax is valid\n' | tee -a "$CONFIG_LOG"
          else
            printf '[FAIL] Configuration has syntax errors\n' | tee -a "$CONFIG_LOG"
            exit 1
          fi
          
          printf '\n%s\n' "=== Loading Configuration ===" >> "$CONFIG_LOG"
          
          # Source in subshell to test loading
          if (source "$CONFIG_FILE" 2>&1) | tee -a "$CONFIG_LOG"; then
            printf '[PASS] Configuration loads successfully\n' | tee -a "$CONFIG_LOG"
          else
            printf '[FAIL] Configuration failed to load\n' | tee -a "$CONFIG_LOG"
            exit 1
          fi
          
          # Source for variable checking
          source "$CONFIG_FILE"
          
          printf '\n%s\n' "=== Required Variables Check ===" >> "$CONFIG_LOG"
          
          REQUIRED_VARS=(
            "TOOLS_PATH"
            "USER_AGENT"
            "OSINT_ENABLED"
            "SUBDOMAIN_ENABLED"
            "DNS_ENABLED"
            "WEBPROBE_ENABLED"
            "PORTSCAN_ENABLED"
            "VULNSCAN_ENABLED"
            "PARALLEL_ENABLED"
            "LOGGING_ENABLED"
          )
          
          MISSING=0
          for var in "${REQUIRED_VARS[@]}"; do
            if [[ -z "${!var+x}" ]]; then
              printf '[MISSING] %s\n' "$var" | tee -a "$CONFIG_LOG"
              MISSING=$((MISSING + 1))
            else
              printf '[OK] %s = %s\n' "$var" "${!var}" | tee -a "$CONFIG_LOG"
            fi
          done
          
          if [[ $MISSING -gt 0 ]]; then
            printf '\n[WARNING] %d required variables are missing\n' "$MISSING" | tee -a "$CONFIG_LOG"
          fi
          
          printf '\n%s\n' "=== All Defined Variables (non-sensitive) ===" >> "$CONFIG_LOG"
          grep -E '^\s*[A-Z_]+=.*' "$CONFIG_FILE" 2>/dev/null | grep -v 'KEY\|TOKEN\|SECRET\|PASS' | head -100 >> "$CONFIG_LOG" || true
          
          cat "$CONFIG_LOG"

      - name: Validate plugins.json
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "PLUGINS CONFIGURATION VALIDATION"
          printf '%s\n' "========================================"
          
          PLUGINS_FILE="config/plugins.json"
          
          if [[ -f "$PLUGINS_FILE" ]]; then
            printf 'Validating: %s\n' "$PLUGINS_FILE"
            if jq '.' "$PLUGINS_FILE" > /dev/null 2>&1; then
              printf '[PASS] Valid JSON\n'
              jq '.' "$PLUGINS_FILE"
            else
              printf '[FAIL] Invalid JSON\n'
              cat "$PLUGINS_FILE"
            fi
          else
            printf '[SKIP] plugins.json not found\n'
          fi

      - name: Upload Config Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: config-validation-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/config/
          retention-days: 30

  ################################################################################
  # JOB 4: File Structure Validation (Uses Helper Script)
  ################################################################################
  structure-validation:
    name: "4. File Structure Validation"
    runs-on: ubuntu-latest
    needs: environment-info
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/structure

      - name: Install Tree
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y -qq tree

      - name: Validate Project Structure
        run: |
          set -euo pipefail
          chmod +x .github/scripts/validate-structure.sh
          ./.github/scripts/validate-structure.sh

      - name: Upload Structure Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: structure-validation-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/structure/
          retention-days: 30

  ################################################################################
  # JOB 5: Library Loading Tests (Uses Helper Script)
  ################################################################################
  library-tests:
    name: "5. Library Loading Tests"
    runs-on: ubuntu-latest
    needs: [environment-info, syntax-validation]
    continue-on-error: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/library

      - name: Test Library Loading
        run: |
          set -euo pipefail
          chmod +x .github/scripts/test-library-loading.sh
          ./.github/scripts/test-library-loading.sh

      - name: Upload Library Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: library-tests-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/library/
          retention-days: 30

  ################################################################################
  # JOB 6: Module Loading Tests (Uses Helper Script)
  ################################################################################
  module-tests:
    name: "6. Module Loading Tests"
    runs-on: ubuntu-latest
    needs: [environment-info, library-tests]
    continue-on-error: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/module

      - name: Test Module Loading
        run: |
          set -euo pipefail
          chmod +x .github/scripts/test-module-loading.sh
          ./.github/scripts/test-module-loading.sh

      - name: Upload Module Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: module-tests-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/module/
          retention-days: 30

  ################################################################################
  # JOB 7: Main Script Tests
  ################################################################################
  main-script-tests:
    name: "7. Main Script Tests"
    runs-on: ubuntu-latest
    needs: [environment-info]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/main

      - name: Make Scripts Executable
        run: |
          set -euo pipefail
          chmod +x neko.sh install.sh run_tests.sh 2>/dev/null || true
          chmod +x modules/*.sh lib/*.sh 2>/dev/null || true

      - name: Test Help Command
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "TESTING HELP COMMAND"
          printf '%s\n' "========================================"
          
          ./neko.sh --help > logs/main/help_output.log 2>&1 || true
          
          printf '%s\n' "=== Help Output ==="
          cat logs/main/help_output.log
          
          # Check help output contains expected content
          if grep -q "USAGE\|usage\|Usage" logs/main/help_output.log 2>/dev/null; then
            printf '[PASS] Help contains USAGE\n'
          else
            printf '[WARN] Help missing USAGE section\n'
          fi
          
          if grep -qE '\-d|\-\-domain' logs/main/help_output.log 2>/dev/null; then
            printf '[PASS] Help documents -d/--domain option\n'
          else
            printf '[WARN] Help missing domain option\n'
          fi

      - name: Test Version Command
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "TESTING VERSION COMMAND"
          printf '%s\n' "========================================"
          
          ./neko.sh --version > logs/main/version_output.log 2>&1 || true
          
          VERSION=$(cat logs/main/version_output.log)
          printf 'Version output: %s\n' "$VERSION"
          
          if [[ "$VERSION" =~ ^Neko|^neko|NEKO ]]; then
            printf '[PASS] Version format correct\n'
          else
            printf '[WARN] Unexpected version format: %s\n' "$VERSION"
          fi

      - name: Test Check-Tools Command
        continue-on-error: true
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "TESTING CHECK-TOOLS COMMAND"
          printf '%s\n' "========================================"
          
          ./neko.sh --check-tools > logs/main/check_tools_output.log 2>&1 || true
          
          printf '%s\n' "=== Check Tools Output ==="
          cat logs/main/check_tools_output.log
          
          # This is expected to show missing tools - that's fine for testing

      - name: Test Invalid Arguments
        run: |
          set -uo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "TESTING INVALID ARGUMENTS"
          printf '%s\n' "========================================"
          
          # Test missing domain
          printf '%s\n' "--- Testing missing domain ---"
          if ./neko.sh 2>&1 | tee logs/main/no_domain.log; then
            printf '[WARN] Should have failed without domain\n'
          else
            printf '[PASS] Correctly requires domain\n'
          fi
          
          # Test invalid option
          printf '\n%s\n' "--- Testing invalid option ---"
          if ./neko.sh --invalid-option-xyz 2>&1 | tee logs/main/invalid_option.log; then
            printf '[WARN] Should have failed with invalid option\n'
          else
            printf '[PASS] Correctly rejects invalid option\n'
          fi

      - name: Upload Main Script Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: main-script-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/main/
          retention-days: 30

  ################################################################################
  # JOB 8: Installation Tests (Full)
  ################################################################################
  installation-tests:
    name: "8. Installation Tests"
    runs-on: ubuntu-latest
    needs: [environment-info, main-script-tests]
    if: ${{ github.event.inputs.skip_installation != 'true' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/install

      - name: System Preparation
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "SYSTEM PREPARATION"
          printf '%s\n' "========================================"
          
          sudo apt-get update
          sudo apt-get install -y \
            curl wget git jq python3 python3-pip python3-venv \
            build-essential libpcap-dev libssl-dev \
            nmap whois dnsutils bc netcat-openbsd \
            parallel sqlite3 2>&1 | tee logs/install/system_prep.log
          
          printf '\n[OK] System packages installed\n'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Verify Go Installation
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "GO INSTALLATION VERIFICATION"
          printf '%s\n' "========================================"
          
          go version
          printf 'GOPATH: %s\n' "$(go env GOPATH)"
          printf 'GOROOT: %s\n' "$(go env GOROOT)"
          
          export PATH="$PATH:$(go env GOPATH)/bin"
          printf 'PATH: %s\n' "$PATH"

      - name: Install Go Tools (Sample)
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "INSTALLING SAMPLE GO TOOLS"
          printf '%s\n' "========================================"
          
          INSTALL_LOG="logs/install/go_tools.log"
          printf 'Timestamp: %s\n' "$(date)" > "$INSTALL_LOG"
          
          GO_TOOLS=(
            "github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest"
            "github.com/projectdiscovery/httpx/cmd/httpx@latest"
            "github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
            "github.com/projectdiscovery/dnsx/cmd/dnsx@latest"
            "github.com/tomnomnom/anew@latest"
          )
          
          INSTALLED=0
          FAILED=0
          
          for tool in "${GO_TOOLS[@]}"; do
            TOOL_NAME=$(basename "${tool%@*}")
            printf '\n--- Installing: %s ---\n' "$TOOL_NAME" >> "$INSTALL_LOG"
            
            if go install "$tool" 2>&1 | tee -a "$INSTALL_LOG"; then
              printf '[PASS] %s installed\n' "$TOOL_NAME" | tee -a "$INSTALL_LOG"
              INSTALLED=$((INSTALLED + 1))
            else
              printf '[FAIL] %s failed\n' "$TOOL_NAME" | tee -a "$INSTALL_LOG"
              FAILED=$((FAILED + 1))
            fi
          done
          
          printf '\n%s\n' "========================================"
          printf '%s\n' "GO TOOLS INSTALLATION SUMMARY"
          printf '%s\n' "========================================"
          printf 'Installed: %d\n' "$INSTALLED"
          printf 'Failed: %d\n' "$FAILED"
          
          export PATH="$PATH:$(go env GOPATH)/bin"
          
          printf '\n%s\n' "=== Verifying Installed Tools ==="
          for tool in "${GO_TOOLS[@]}"; do
            TOOL_NAME=$(basename "${tool%@*}")
            if command -v "$TOOL_NAME" &>/dev/null; then
              printf '[OK] %s: %s\n' "$TOOL_NAME" "$(command -v "$TOOL_NAME")"
            else
              printf '[MISSING] %s\n' "$TOOL_NAME"
            fi
          done

      - name: Install Python Tools (Sample)
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "INSTALLING SAMPLE PYTHON TOOLS"
          printf '%s\n' "========================================"
          
          INSTALL_LOG="logs/install/python_tools.log"
          printf 'Timestamp: %s\n' "$(date)" > "$INSTALL_LOG"
          
          python3 -m pip install --upgrade pip
          
          PIP_TOOLS=(
            "wafw00f"
            "uro"
          )
          
          for tool in "${PIP_TOOLS[@]}"; do
            printf '\n--- Installing: %s ---\n' "$tool" >> "$INSTALL_LOG"
            
            if python3 -m pip install --user "$tool" 2>&1 | tee -a "$INSTALL_LOG"; then
              printf '[PASS] %s installed\n' "$tool" | tee -a "$INSTALL_LOG"
            else
              printf '[FAIL] %s failed\n' "$tool" | tee -a "$INSTALL_LOG"
            fi
          done

      - name: Test Tool Integration
        run: |
          set -euo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "TOOL INTEGRATION TEST"
          printf '%s\n' "========================================"
          
          INTEGRATION_LOG="logs/install/integration.log"
          printf 'Timestamp: %s\n' "$(date)" > "$INTEGRATION_LOG"
          
          export PATH="$PATH:$(go env GOPATH)/bin:$HOME/.local/bin"
          
          # Test subfinder
          printf '%s\n' "--- Testing subfinder ---" >> "$INTEGRATION_LOG"
          if subfinder --version >> "$INTEGRATION_LOG" 2>&1; then
            printf '[PASS] subfinder works\n' | tee -a "$INTEGRATION_LOG"
          else
            printf '[FAIL] subfinder error\n' | tee -a "$INTEGRATION_LOG"
          fi
          
          # Test httpx
          printf '\n%s\n' "--- Testing httpx ---" >> "$INTEGRATION_LOG"
          if httpx --version >> "$INTEGRATION_LOG" 2>&1; then
            printf '[PASS] httpx works\n' | tee -a "$INTEGRATION_LOG"
          else
            printf '[FAIL] httpx error\n' | tee -a "$INTEGRATION_LOG"
          fi
          
          # Test nuclei
          printf '\n%s\n' "--- Testing nuclei ---" >> "$INTEGRATION_LOG"
          if nuclei --version >> "$INTEGRATION_LOG" 2>&1; then
            printf '[PASS] nuclei works\n' | tee -a "$INTEGRATION_LOG"
          else
            printf '[FAIL] nuclei error\n' | tee -a "$INTEGRATION_LOG"
          fi
          
          cat "$INTEGRATION_LOG"

      - name: Upload Installation Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: installation-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/install/
          retention-days: 30

  ################################################################################
  # JOB 9: Run Test Suite
  ################################################################################
  run-test-suite:
    name: "9. Run Test Suite"
    runs-on: ubuntu-latest
    needs: [environment-info]
    continue-on-error: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Log Directory
        run: |
          set -euo pipefail
          mkdir -p logs/testsuite

      - name: Run Neko Test Suite
        run: |
          set -uo pipefail
          
          printf '%s\n' "========================================"
          printf '%s\n' "RUNNING NEKO TEST SUITE"
          printf '%s\n' "========================================"
          
          chmod +x run_tests.sh 2>/dev/null || true
          
          # Run the test suite and capture output
          ./run_tests.sh --no-cleanup 2>&1 | tee logs/testsuite/test_output.log || true
          
          # Copy generated logs
          if [[ -d "test_logs" ]]; then
            cp -r test_logs/* logs/testsuite/ 2>/dev/null || true
          fi

      - name: Upload Test Suite Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: testsuite-logs-${{ needs.environment-info.outputs.run_id }}
          path: logs/testsuite/
          retention-days: 30

  ################################################################################
  # JOB 10: Final Summary
  ################################################################################
  final-summary:
    name: "10. Final Summary"
    runs-on: ubuntu-latest
    needs: [
      environment-info,
      syntax-validation,
      config-validation,
      structure-validation,
      library-tests,
      module-tests,
      main-script-tests,
      run-test-suite
    ]
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-logs
        continue-on-error: true

      - name: Generate Final Summary
        run: |
          # Use set -o pipefail without -u to handle potentially unset variables
          set -o pipefail
          
          # Set job result variables with defaults for missing values
          ENVINFO_RESULT="${{ needs.environment-info.result || 'skipped' }}"
          SYNTAX_RESULT="${{ needs.syntax-validation.result || 'skipped' }}"
          CONFIG_RESULT="${{ needs.config-validation.result || 'skipped' }}"
          STRUCTURE_RESULT="${{ needs.structure-validation.result || 'skipped' }}"
          LIBRARY_RESULT="${{ needs.library-tests.result || 'skipped' }}"
          MODULE_RESULT="${{ needs.module-tests.result || 'skipped' }}"
          MAIN_RESULT="${{ needs.main-script-tests.result || 'skipped' }}"
          TESTSUITE_RESULT="${{ needs.run-test-suite.result || 'skipped' }}"
          RUN_ID="${{ needs.environment-info.outputs.run_id || 'unknown' }}"
          
          printf '%s\n' "========================================"
          printf '%s\n' "NEKO DEEP ERROR DETECTION - FINAL SUMMARY"
          printf '%s\n' "========================================"
          printf '\n'
          printf '%s\n' "Run ID: ${RUN_ID}"
          printf '%s\n' "Timestamp: $(date)"
          printf '\n'
          printf '%s\n' "========================================"
          printf '%s\n' "JOB RESULTS"
          printf '%s\n' "========================================"
          printf '\n'
          printf '%s\n' "1. Environment Info:      ${ENVINFO_RESULT}"
          printf '%s\n' "2. Syntax Validation:     ${SYNTAX_RESULT}"
          printf '%s\n' "3. Config Validation:     ${CONFIG_RESULT}"
          printf '%s\n' "4. Structure Validation:  ${STRUCTURE_RESULT}"
          printf '%s\n' "5. Library Tests:         ${LIBRARY_RESULT}"
          printf '%s\n' "6. Module Tests:          ${MODULE_RESULT}"
          printf '%s\n' "7. Main Script Tests:     ${MAIN_RESULT}"
          printf '%s\n' "8. Test Suite:            ${TESTSUITE_RESULT}"
          printf '\n'
          
          # Determine overall status
          OVERALL="SUCCESS"
          if [[ "$SYNTAX_RESULT" == "failure" ]]; then
            OVERALL="FAILURE"
            printf '%s\n' "[CRITICAL] Syntax validation failed!"
          fi
          if [[ "$CONFIG_RESULT" == "failure" ]]; then
            OVERALL="FAILURE"
            printf '%s\n' "[CRITICAL] Configuration validation failed!"
          fi
          if [[ "$STRUCTURE_RESULT" == "failure" ]]; then
            OVERALL="FAILURE"
            printf '%s\n' "[CRITICAL] Structure validation failed!"
          fi
          if [[ "$LIBRARY_RESULT" == "failure" ]]; then
            OVERALL="FAILURE"
            printf '%s\n' "[CRITICAL] Library tests failed!"
          fi
          if [[ "$MODULE_RESULT" == "failure" ]]; then
            OVERALL="FAILURE"
            printf '%s\n' "[CRITICAL] Module tests failed!"
          fi
          
          printf '\n'
          printf '%s\n' "========================================"
          printf '%s\n' "OVERALL STATUS: ${OVERALL}"
          printf '%s\n' "========================================"
          printf '\n'
          printf '%s\n' "All logs have been uploaded as artifacts."
          printf '%s\n' "Download them from the Actions page for detailed analysis."
          printf '\n'
          
          # List available logs
          printf '%s\n' "=== Available Log Artifacts ==="
          ls -la all-logs/ 2>/dev/null || printf '%s\n' "No artifacts found"
          
          # Create summary file using a heredoc with variable substitution
          {
            printf '%s\n' "================================================================"
            printf '%s\n' "NEKO DEEP ERROR DETECTION SUMMARY"
            printf '%s\n' "================================================================"
            printf '\n'
            printf '%s\n' "Run ID: ${RUN_ID}"
            printf '%s\n' "Date: $(date)"
            printf '%s\n' "Branch: ${{ github.ref_name }}"
            printf '%s\n' "Commit: ${{ github.sha }}"
            printf '\n'
            printf '%s\n' "================================================================"
            printf '%s\n' "RESULTS"
            printf '%s\n' "================================================================"
            printf '\n'
            printf '%s\n' "Syntax Validation:     ${SYNTAX_RESULT}"
            printf '%s\n' "Config Validation:     ${CONFIG_RESULT}"
            printf '%s\n' "Structure Validation:  ${STRUCTURE_RESULT}"
            printf '%s\n' "Library Tests:         ${LIBRARY_RESULT}"
            printf '%s\n' "Module Tests:          ${MODULE_RESULT}"
            printf '%s\n' "Main Script Tests:     ${MAIN_RESULT}"
            printf '%s\n' "Test Suite:            ${TESTSUITE_RESULT}"
            printf '\n'
            printf '%s\n' "================================================================"
            printf '%s\n' "OVERALL: ${OVERALL}"
            printf '%s\n' "================================================================"
          } > final-summary.txt
          
          cat final-summary.txt
          
          # Exit with appropriate code
          if [[ "$OVERALL" == "FAILURE" ]]; then
            exit 1
          fi

      - name: Upload Final Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-summary-${{ needs.environment-info.outputs.run_id }}
          path: final-summary.txt
          retention-days: 30
